variables:
  NODE_VERSION: node:16.14-alpine
  CI: 'true'

image: $NODE_VERSION

default:
  tags:
    - gitlab-runner-ec2
  before_script:
    - yarn install --cache-folder .yarn-cache --immutable --immutable-cache --check-cache
    - NX_HEAD=$CI_COMMIT_SHA
    - NX_BASE=${CI_MERGE_REQUEST_DIFF_BASE_SHA:-$CI_COMMIT_BEFORE_SHA}
    - NX_BRANCH=pipeline  # Defina a variável NX_BRANCH com o nome da branch atual
    - NX_CI_EXECUTION_ID=$CI_PIPELINE_ID  # Defina a variável NX_CI_EXECUTION_ID com o ID do pipeline atual
    - yarn nx affected --base=$NX_BASE --head=$NX_HEAD --target=test --parallel=3 --ci --code-coverage

stages:
  - build
  - test
  - e2e

#ui-components-admin jobs
ui-components-admin build:
  stage: build
  only:
  - main
  - marge_requests
  - qa
  script:
    - yarn nx build ui-components-admin

ui-components-admin test:
  stage: test
  script:
    - yarn nx test ui-components-admin

ui-components-admin:
  stage: e2e
  image: cypress/browsers:node18.12.0-chrome107
  script:
    - apt-get update && apt-get install -y xvfb
    - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    - export DISPLAY=:99
    - yarn nx component-test ui-components-admin --graph=output.html

  artifacts:
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
      - node_modules
    expire_in: 1 day

#admin jobs
admin build:
  stage: build
  needs: ["ui-components-admin build"]
  only:
  - main
  - marge_requests
  - qa
  script:
    - yarn nx build admin

admin test:
  stage: test
  script:
    - yarn nx test admin

# voting jobs
voting build:
  stage: build
  needs: ["ui-components-admin build"]
  only:
  - main
  - marge_requests
  - qa
  script:
    - yarn nx build voting

voting test:
  stage: test
  script:
    - yarn nx test voting

  environment: production
