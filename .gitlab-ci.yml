variables:
  NODE_VERSION: node:16.14-alpine
  CI: 'true'

image: $NODE_VERSION

default:
  tags:
    - gitlab-runner-ec2
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - '.yarn-cache/'
  before_script:
    - yarn install --cache-folder .yarn-cache --prefer-offline --frozen-lockfile

stages:
  - build
  - test
  - e2e

#ui-components-admin jobs
ui-components-admin build:
  stage: build
  script:
    - yarn nx build ui-components-admin
  only:
    refs:
      - main
      - merge_requests
    changes:
      - libs/ui-components-admin/**/*
  except:
    changes:
      - libs/ui-components-admin/**/*.{json,md}
      - libs/ui-components-admin/**/*.test.{js,ts,jsx,tsx}
      - libs/ui-components-admin/**/*.spec.{js,ts,jsx,tsx}

ui-components-admin test:
  stage: test
  script:
    - yarn nx test ui-components-admin
  only:
    refs:
      - main
      - merge_requests
    changes:
      - libs/ui-components-admin/**/*
  except:
    changes:
      - libs/ui-components-admin/**/*.{json,md}
      - libs/ui-components-admin/**/*.test.{js,ts,jsx,tsx}
      - libs/ui-components-admin/**/*.spec.{js,ts,jsx,tsx}

ui-components-admin e2e:
  stage: e2e
  image: cypress/browsers:node18.12.0-chrome107
  script:
    - apt-get update && apt-get install -y xvfb
    - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    - export DISPLAY=:99
    - yarn nx component-test ui-components-admin --graph=output.html
  only:
    refs:
      - main
      - merge_requests
    changes:
      - libs/ui-components-admin/**/*
  except:
    changes:
      - libs/ui-components-admin/**/*.{json,md}
      - libs/ui-components-admin/**/*.test.{js,ts,jsx,tsx}
      - libs/ui-components-admin/**/*.spec.{js,ts,jsx,tsx}

  artifacts:
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
    expire_in: 1 day

#admin jobs
admin build:
  stage: build
  needs: ["ui-components-admin build"]
  script:
    - yarn nx build admin
  only:
    refs:
      - main
      - merge_requests
    changes:
      - apps/admin/**/*
  except:
    changes:
      - apps/admin/**/*.{json,md}
      - apps/admin/**/*.test.{js,ts,jsx,tsx}
      - apps/admin/**/*.spec.{js,ts,jsx,tsx}


admin test:
  stage: test
  script:
    - yarn nx test admin
  only:
    refs:
      - main
      - merge_requests
    changes:
      - apps/admin/**/*
  except:
    changes:
      - apps/admin/**/*.{json,md}
      - apps/admin/**/*.test.{js,ts,jsx,tsx}
      - apps/admin/**/*.spec.{js,ts,jsx,tsx}


# voting jobs
voting build:
  stage: build
  needs: ["ui-components-admin build"]
  script:
    - yarn nx build voting
  only:
    refs:
      - main
      - merge_requests
    changes:
      - apps/voting/**/*
  except:
    changes:
      - apps/voting/**/*.{json,md}
      - apps/voting/**/*.test.{js,ts,jsx,tsx}
      - apps/voting/**/*.spec.{js,ts,jsx,tsx}


voting test:
  stage: test
  script:
    - yarn nx test voting
  only:
    refs:
      - merge_requests
    changes:
      - apps/voting/**/*
  except:
    changes:
      - apps/voting/**/*.{json,md}
      - apps/voting/**/*.test.{js,ts,jsx,tsx}
      - apps/voting/**/*.spec.{js,ts,jsx,tsx}

  environment: production
